'use strict';window.tsfem_e_import=function(){const a=tsfem_e_transportL10n,b=5e3,c=5,d=a=>{a||=!1,["importer-submit"].forEach(b=>{const c=document.getElementById(`tsfem-e-transport-${b}`);c.classList.toggle("tsfem-button-disabled",a),c.disabled=a})},e=()=>d(!0),f=(a,b,c)=>{const d="#tsfem-e-transport-log-ajax";switch(a||"start"){case"start":tsfem.resetAjaxLoader(d),tsfem.setAjaxLoader(d);break;case"end":tsfem.updatedResponse(d,b,c);}},g=b=>{const c=b.target;if(c.disabled)return;let g=["tsfem-button-loading"];c.classList.add(...g),e(),f(),l();const j="tsfem-e-transport-importer",k=document.getElementById(j),n=new FormData(k);[...n.keys()].forEach(a=>{k.querySelectorAll(`[name="[${a}]"]`).forEach(a=>{a.dataset.handlerDisabled=!a.disabled,a.disable=!0})});const o="undefined"==typeof EventSource?i:h;o("import",n,a.i18n.logMessages.requestImport.replace("%s",k.querySelector(`[value="${n.get(`${j}[choosePlugin]`)}"]`)?.dataset.title)).then(a=>{f("end",1,a)}).catch(a=>{f("end",0,a)}).finally(()=>{d(),c.classList.remove(...g),[...n.keys()].forEach(a=>{k.querySelectorAll(`[name="${a}"]`).forEach(a=>{a.dataset.handlerDisabled&&(a.disabled=!1),delete a.dataset.handlerDisabled})}),m()})},h=(d,e,f)=>new Promise((g,h)=>{const i=new URL(ajaxurl,new URL(document.baseURI).origin);i.searchParams.set("action","tsfem_e_transport"),i.searchParams.set("handle",d),i.searchParams.set("nonce",a.nonce),i.searchParams.set("data",e&&new URLSearchParams([...e.entries()]).toString());let j=0,l=1;const m=()=>{i.searchParams.set("retryAllowed",l);const d=new EventSource(i.href);d.onopen=()=>{k(f)},d.onerror=()=>{d.close(),k(a.i18n.logMessages.unknownErrorFull,2),h(a.i18n.logMessages.unknownError)};const e=a=>{try{return JSON.parse(a)}catch(a){}},n=a=>{d.close();let b=e(a.data);k("&nbsp;"),k(b?.logMsg,2),h(b?.results.notice)},o=f=>{if(j++,k("===============",1),j>c)return k(a.i18n.logMessages.retryLimitReached),n(f);l=j<c?1:0,d.close(),k(e(f.data)?.logMsg,1);let g=1;const h=setInterval(()=>{let c=b/1e3-g++,d=2>c;k(a.i18n.logMessages.retryCountdown.replace("%d",c),d?1:0),d&&clearInterval(h)},1e3);setTimeout(m,b)};d.addEventListener("tsfem-e-transport-log",a=>{k(e(a.data)?.content)}),d.addEventListener("tsfem-e-transport-done",a=>{d.close();let b=e(a.data);k("&nbsp;"),k("\n"+b.logMsg,2),g(b?.results.notice)}),d.addEventListener("tsfem-e-transport-failure",n),d.addEventListener("tsfem-e-transport-locked",n),d.addEventListener("tsfem-e-transport-crash",o),d.addEventListener("tsfem-e-transport-timeout",o)};m()}),i=(b,c,d)=>new Promise((e,f)=>{k(d,1),wp.ajax.post("tsfem_e_transport",{handle:b,nonce:a.nonce,data:c&&new URLSearchParams([...c.entries()]).toString()}).done(a=>{e(a?.results?.notice),k(a?.logMsg,2)}).fail(a=>{f(a.data?.results?.notice),k(a.data?.logMsg,2)})}),j=document.getElementById("tsfem-e-transport-logger"),k=(a,b)=>{j&&a?.length&&tsfem_ui.logger.queue(j,`\n&ratio; ${tsf.escapeString(tsf.decodeEntities(a))}${"\n".repeat(b||0)}`)},l=()=>j&&tsfem_ui.logger.start(j),m=()=>j&&tsfem_ui.logger.stop(j),n=a=>{if(!j)return;const b=()=>setTimeout(()=>{tsfTT.removeTooltip(a.target)},3e3);tsfem_ui.logger.copy(j).then(()=>{tsfTT.doTooltip(a,a.target,a.target.dataset.copyconfirm),b()}).catch(()=>{tsfTT.doTooltip(a,a.target,a.target.dataset.copyfail),b()})},o=()=>j&&tsfem_ui.logger.scrollToBottom(j),p=b=>{if(b.preventDefault(),b.stopPropagation(),b.target.dataset?.lastValue===b.target.value)return;b.target.dataset.lastValue=b.target.value;const c="tsfem-e-transport-importer",d=JSON.parse(b.target.selectedOptions[0]?.dataset.importers),e=document.getElementById(`${c}-options`),f=document.getElementById(`${c}-supports-transformation-help`),h=document.getElementById(`${c}-submit`);e.innerHTML="",e.style.display="none",f.style.display="none";let i=!1,j=!1;const k=()=>{const a=document.querySelectorAll(`[name^="${c}\\[selectType\\]"]:checked`);i=!1,a.forEach(a=>{i=!!d[a.value]?.transform?.length}),f.style.display=i?null:"none";const b=!a.length;h.disabled=b,h.classList.toggle("tsfem-button-disabled",b)},l=b=>{const d=document.getElementById(`${c}-options-template`).content.cloneNode(!0);d.querySelector(`.${c}-selectType-description`).innerText=a.i18n.optionNames[b]??"";const f=d.querySelector(`[name^="${c}\\[selectType\\]"]`);f.value=b,e.appendChild(d),f.addEventListener("change",k),f.dispatchEvent(new Event("change"))};d.postmeta&&(l("postmeta"),j=!0),d.termmeta&&(l("termmeta"),j=!0),j&&(e.style.display=null),h.addEventListener("click",g)},q=()=>{const a=document.getElementById("tsfem-e-transport-importer[choosePlugin]");a.addEventListener("change",p),a.dispatchEvent(new Event("change")),document.getElementById("tsfem-e-transport-copy-log")?.addEventListener("click",n),document.getElementById("tsfem-e-transport-scroll-log")?.addEventListener("click",o)};return Object.assign({load:()=>{document.body.addEventListener("tsf-onload",q)}})}(),window.tsfem_e_import.load();
